<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Camera permissions -->
    <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(self)">
    <meta http-equiv="Feature-Policy" content="camera 'self'; microphone 'self'">

    <title>Book Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #2e8b57;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .info-box {
            background-color: #e7f3ff;
            padding: 18px;
            border-left: 5px solid #2196F3;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .warning-box {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(238, 90, 111, 0.3);
            border: 3px solid #ff5252;
            display: none;
        }

        .warning-box h2 {
            color: white;
            margin-top: 0;
            font-size: 24px;
            text-align: center;
        }

        .warning-box p {
            color: white;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 139, 87, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: white;
            color: #ff5252;
            padding: 20px 50px;
            font-size: 20px;
        }

        .btn-warning:hover {
            transform: scale(1.05);
        }

        #cameraViewContainer {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        #reader {
            width: 100%;
            border: 2px solid #2e8b57;
            border-radius: 10px;
        }

        #scanStatus {
            margin-top: 10px;
            background: #e7f3ff;
            color: #2196F3;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            border-left: 4px solid #2196F3;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        #scannedBookDetails {
            display: none;
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #2e8b57;
            margin-bottom: 20px;
        }

        #scannedBookDetails h3 {
            color: #2e8b57;
            margin-bottom: 20px;
        }

        .detail-item {
            margin-bottom: 15px;
        }

        .detail-item strong {
            color: #5d4e37;
            display: block;
            margin-bottom: 5px;
        }

        .detail-item p {
            margin: 0;
            font-size: 16px;
        }

        #historyList {
            display: grid;
            gap: 10px;
        }

        .history-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e8b57;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            max-width: 400px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        /* ISBN List Section */
        #isbnListSection {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #2e8b57;
        }

        #isbnListSection h3 {
            color: #2e8b57;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-grid-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .refresh-grid-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }

        /* Table Styles */
        .isbn-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .isbn-table thead {
            background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
            color: white;
        }

        .isbn-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .isbn-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        .isbn-table tbody tr {
            transition: all 0.3s ease-in-out;
        }

        .isbn-table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        .isbn-table tbody tr {
            opacity: 1;
            transform: translateX(0);
        }

        .isbn-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Slide Button Container */
        .slide-button-cell {
            padding: 8px !important;
        }

        /* Initial state - glossy light grey */
        .slide-container {
            position: relative;
            width: 320px;
            height: 60px;
            background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%);
            border-radius: 30px;
            overflow: hidden;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1),
                        0 2px 10px rgba(0,0,0,0.15),
                        0 0 15px rgba(255,255,255,0.5);
            touch-action: none;
            user-select: none;
            border: 1px solid #d0d0d0;
            transition: all 0.4s ease;
        }

        /* Active state - green arrow indicator only */
        .slide-container.active .slide-button {
            background: linear-gradient(180deg, #90ee90 0%, #7bcf7b 100%);
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.5),
                        inset 0 2px 6px rgba(255,255,255,0.6),
                        inset 0 -2px 6px rgba(46, 139, 87, 0.2);
            border: 2px solid #6bc46b;
            color: #2d5a2d;
        }

        .slide-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
            border-radius: 25px;
            transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .slide-button {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            background: linear-gradient(180deg, #ffffff 0%, #f5f5f5 100%);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2),
                        inset 0 2px 6px rgba(255,255,255,1),
                        inset 0 -2px 4px rgba(0,0,0,0.08);
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            z-index: 2;
            border: 2px solid #e8e8e8;
            color: #888;
        }

        /* Active state - green arrow (lit green button) */
        .slide-container.active .slide-button {
            background: linear-gradient(180deg, #90ee90 0%, #7bcf7b 100%);
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.5),
                        inset 0 2px 6px rgba(255,255,255,0.6),
                        inset 0 -2px 6px rgba(46, 139, 87, 0.2);
            border: 2px solid #6bc46b;
            color: #2d5a2d;
        }

        .slide-button:active {
            cursor: grabbing;
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .slide-text {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            pointer-events: none;
            z-index: 1;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }

        /* Processing state */
        .slide-container.processing {
            background: linear-gradient(90deg, #4a90e2 0%, #5ba3f5 50%, #4a90e2 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.2),
                        0 2px 15px rgba(74, 144, 226, 0.5);
            border: 1px solid #3a7bc8;
        }

        .slide-container.processing .slide-button {
            left: calc(100% - 55px);
            background: linear-gradient(180deg, #ffffff 0%, #e3f2fd 100%);
            animation: pulse 1s infinite;
            cursor: wait;
        }

        .slide-container.processing .slide-text {
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Success state */
        .slide-container.unlocked {
            background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.15),
                        0 2px 20px rgba(46, 139, 87, 0.6),
                        0 0 30px rgba(60, 179, 113, 0.5);
            border: 1px solid #2e8b57;
            animation: successPulse 0.5s ease;
        }

        .slide-container.unlocked .slide-button {
            left: calc(100% - 55px);
            background: linear-gradient(180deg, #5cb85c 0%, #4caf50 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.6),
                        inset 0 2px 6px rgba(255,255,255,0.4),
                        inset 0 -2px 6px rgba(0,0,0,0.2);
            border: 2px solid #66bb6a;
        }

        .slide-container.unlocked .slide-background {
            width: 100%;
        }

        .slide-container.unlocked .slide-text {
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Animations */
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .empty-grid-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 12px 30px;
                font-size: 14px;
            }

            .isbn-table {
                font-size: 12px;
            }

            .isbn-table th,
            .isbn-table td {
                padding: 10px 8px;
            }

            #mainSlideButton {
                width: 280px;
                height: 50px;
            }

            #mainSlideButton .slide-button {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            #mainSlideButton .slide-text {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Book Barcode Scanner</h1>
        <p class="subtitle">Scan ISBN barcodes to automatically retrieve book information</p>

        <!-- Info Box -->
        <div class="info-box">
            <strong>üìñ How to use:</strong> Click "Start Scanner" below to activate your camera. Point it at a book's ISBN barcode. Once scanned, book details will be fetched automatically from Google Books.
        </div>

        <!-- Iframe Warning -->
        <div id="iframeWarning" class="warning-box">
            <h2>‚ö†Ô∏è Camera Access Blocked</h2>
            <p>
                This page is embedded and camera access is blocked.<br>
                <strong>Click the button below to use the scanner:</strong>
            </p>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="openInNewTab()" class="btn btn-warning">
                    üì∑ Open Scanner (Click Here!)
                </button>
            </div>
            <p style="font-size: 14px; opacity: 0.9;">
                This will open the scanner in a new tab where your camera will work.
            </p>
        </div>

        <!-- Camera View -->
        <div id="cameraViewContainer">
            <div id="reader"></div>
            <div id="scanStatus">Ready to scan</div>
        </div>

        <!-- Scanner Controls -->
        <div class="controls">
            <button id="startScanBtn" class="btn btn-primary" onclick="startScanner()">
                üì∑ Start Scanner
            </button>
            <button id="stopScanBtn" class="btn btn-secondary" onclick="stopScanner()" style="display: none;">
                ‚èπÔ∏è Stop Scanner
            </button>
        </div>

        <!-- Scanned Book Details -->
        <div id="scannedBookDetails">
            <h3>üìö Scanned Book Details</h3>
            <div class="detail-item">
                <strong>ISBN:</strong>
                <p id="scannedISBN"></p>
            </div>
            <div class="detail-item">
                <strong>Book Title:</strong>
                <p id="scannedBookTitle" style="font-weight: 600;"></p>
            </div>
            <div class="detail-item">
                <strong>Author(s):</strong>
                <p id="scannedAuthor"></p>
            </div>
            <div class="detail-item">
                <strong>Publisher:</strong>
                <p id="scannedPublisher"></p>
            </div>
            <div class="detail-item">
                <strong>Published Date:</strong>
                <p id="scannedPublishedDate"></p>
            </div>
            <div class="detail-item">
                <strong>Categories:</strong>
                <p id="scannedCategories"></p>
            </div>
            <div class="detail-item">
                <strong>Description:</strong>
                <p id="scannedDescription" style="font-size: 14px; line-height: 1.6; color: #666;"></p>
            </div>

            <div style="margin-top: 25px; text-align: center;">
                <button id="saveToISBNListBtn" class="btn btn-primary" onclick="saveToISBNList()" style="display: none;">
                    üíæ Save to ISBN List
                </button>
                <button class="btn btn-secondary" onclick="clearScannedBook()">
                    üîÑ Scan Another
                </button>
            </div>
        </div>

        <!-- ISBN Scanned Books Section -->
        <div id="isbnListSection">
            <h3>
                <span>üìö ISBN Scanned Books</span>
                <button class="refresh-grid-btn" onclick="loadISBNList()">üîÑ Refresh</button>
            </h3>

            <!-- Form for Book Registry Details -->
            <div id="registryForm" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #2e8b57;">
                <h4 style="color: #2e8b57; margin-bottom: 15px;">üìù Book Registry Information</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #5d4e37;">
                            Contact Person <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="contactPerson" placeholder="Enter contact person name"
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #5d4e37;">
                            Contact Number <span style="color: red;">*</span>
                        </label>
                        <input type="tel" id="contactNumber" placeholder="Enter contact number"
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #5d4e37;">
                            Unit No <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="unitNo" placeholder="Enter unit number"
                            style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #666; font-style: italic;">
                    Fill in these details before sliding to save to Book Registry
                </p>
            </div>

            <!-- Table View -->
            <div id="isbnTableContainer" style="overflow-x: auto;">
                <div class="empty-grid-message">Loading ISBN List...</div>
            </div>

            <!-- iPhone-style Slide to Save Button -->
            <div id="slideToSaveSection" style="margin-top: 30px; text-align: center; display: none;">
                <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                    <strong id="bookCount">0</strong> book(s) ready to save. Slide to save all to Book Registry.
                </p>
                <div style="display: flex; justify-content: center;">
                    <div class="slide-container" id="mainSlideButton">
                        <div class="slide-background"></div>
                        <div class="slide-text">Slide to Save All ‚Üí</div>
                        <div class="slide-button">‚Üí</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertBox" class="alert"></div>

    <script>
        // Configuration
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbytd5eKdlkBLJ9nxS2jx1C5A4pFNdkISnJoPwt2VFu7jzUpMYOa_F6oeZh1o4GY-pOO_w/exec';
        let API_URL = localStorage.getItem('apiUrl') || DEFAULT_API_URL;

        let html5QrcodeScanner = null;
        let currentScannedBook = null;
        let isScannerActive = false;

        // Check if running in iframe
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }

        // Open in new tab
        function openInNewTab() {
            const currentUrl = window.location.href;
            window.open(currentUrl, '_blank');
        }

        // Show alert
        function showAlert(message, type) {
            const alertEl = document.getElementById('alertBox');
            alertEl.textContent = message;
            alertEl.className = 'alert alert-' + type;
            alertEl.style.display = 'block';

            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }

        // Check iframe permissions on load
        async function checkIframePermissions() {
            console.log('=== IFRAME PERMISSION CHECK ===');

            if (!isInIframe()) {
                console.log('‚úÖ Not in iframe - camera should work normally');
                document.getElementById('iframeWarning').style.display = 'none';
                return;
            }

            console.log('‚ö†Ô∏è Running in iframe - checking camera...');
            document.getElementById('iframeWarning').style.display = 'block';

            try {
                const testStream = await navigator.mediaDevices.getUserMedia({ video: true });
                testStream.getTracks().forEach(track => track.stop());
                console.log('‚úÖ Camera IS accessible in iframe!');
                document.getElementById('iframeWarning').style.display = 'none';
            } catch (error) {
                console.log('‚ùå Camera NOT accessible in iframe');
                document.getElementById('iframeWarning').style.display = 'block';
            }
        }

        // Check camera permissions
        async function checkCameraPermissions() {
            console.log('=== CAMERA PERMISSION CHECK ===');

            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                throw new Error('Camera access requires HTTPS.');
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Your browser does not support camera access.');
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    throw new Error('Camera permission denied. Please click "Allow" when asked.');
                }
                throw error;
            }
        }

        // Start Scanner
        async function startScanner() {
            try {
                document.getElementById('cameraViewContainer').style.display = 'block';
                document.getElementById('scanStatus').textContent = 'Checking camera permissions...';

                await checkCameraPermissions();
                document.getElementById('iframeWarning').style.display = 'none';

                document.getElementById('scanStatus').textContent = 'Initializing camera...';

                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }

                const config = {
                    fps: 10,
                    qrbox: { width: 300, height: 150 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E
                    ]
                };

                const onScanSuccess = async (decodedText) => {
                    console.log('Scanned barcode:', decodedText);
                    document.getElementById('scanStatus').textContent = `ISBN detected: ${decodedText}. Fetching book details...`;
                    document.getElementById('scanStatus').style.background = '#d4edda';
                    document.getElementById('scanStatus').style.color = '#155724';
                    document.getElementById('scanStatus').style.borderLeft = '4px solid #28a745';

                    await stopScanner();
                    await fetchBookDetails(decodedText);
                };

                const onScanFailure = (error) => {
                    // Ignore - fires when no barcode detected
                };

                try {
                    await html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                } catch (error) {
                    await html5QrcodeScanner.start(
                        { facingMode: "user" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                }

                isScannerActive = true;
                document.getElementById('scanStatus').textContent = 'Point camera at ISBN barcode...';
                document.getElementById('scanStatus').style.background = '#e7f3ff';
                document.getElementById('scanStatus').style.color = '#2196F3';
                document.getElementById('scanStatus').style.borderLeft = '4px solid #2196F3';
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-block';

                showAlert('Scanner activated!', 'success');
            } catch (error) {
                console.error('‚ùå Error starting scanner:', error);

                if (isInIframe() && (error.name === 'NotAllowedError' || error.message.includes('denied'))) {
                    document.getElementById('iframeWarning').style.display = 'block';
                }

                showAlert(error.message || 'Failed to start camera', 'error');
                document.getElementById('cameraViewContainer').style.display = 'none';
                isScannerActive = false;
            }
        }

        // Stop Scanner
        async function stopScanner() {
            try {
                if (html5QrcodeScanner && isScannerActive) {
                    await html5QrcodeScanner.stop();
                    isScannerActive = false;
                }

                document.getElementById('cameraViewContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'inline-block';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('scanStatus').textContent = 'Ready to scan';
                document.getElementById('scanStatus').style.background = '#e7f3ff';
                document.getElementById('scanStatus').style.color = '#2196F3';
            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
        }

        // Fetch Book Details from Google Books API
        async function fetchBookDetails(isbn) {
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const bookInfo = data.items[0].volumeInfo;

                    currentScannedBook = {
                        isbn: isbn,
                        title: bookInfo.title || 'N/A',
                        authors: bookInfo.authors ? bookInfo.authors.join(', ') : 'N/A',
                        publisher: bookInfo.publisher || 'N/A',
                        publishedDate: bookInfo.publishedDate || 'N/A',
                        categories: bookInfo.categories ? bookInfo.categories.join(', ') : 'N/A',
                        description: bookInfo.description || 'No description available',
                        language: bookInfo.language ? bookInfo.language : "N/A"
      
                    };

                    displayScannedBook(currentScannedBook);
                    showAlert('Book details retrieved!', 'success');

                    // Auto-save to ISBN_List
                    await saveToISBNList();
                } else {
                    showAlert('No book details found for ISBN: ' + isbn, 'error');
                    currentScannedBook = {
                        isbn: isbn,
                        title: 'Not Found',
                        authors: 'N/A',
                        publisher: 'N/A',
                        publishedDate: 'N/A',
                        categories: 'N/A',
                        description: 'No information available for this ISBN',
                        language: 'N/A'
                    };
                    displayScannedBook(currentScannedBook);
                }
            } catch (error) {
                console.error('Error fetching book details:', error);
                showAlert('Error fetching book details', 'error');
            }
        }

        // Display Scanned Book
        function displayScannedBook(book) {
            document.getElementById('scannedISBN').textContent = book.isbn;
            document.getElementById('scannedBookTitle').textContent = book.title;
            document.getElementById('scannedAuthor').textContent = book.authors;
            document.getElementById('scannedPublisher').textContent = book.publisher;
            document.getElementById('scannedPublishedDate').textContent = book.publishedDate;
            document.getElementById('scannedCategories').textContent = book.categories;
            document.getElementById('scannedLanguage').textContent = book.language;
            document.getElementById('scannedDescription').textContent = book.description;
            document.getElementById('scannedBookDetails').style.display = 'block';
        }

        // Clear Scanned Book
        function clearScannedBook() {
            currentScannedBook = null;
            document.getElementById('scannedBookDetails').style.display = 'none';
        }

        // Save to ISBN_List Sheet
        async function saveToISBNList() {
            if (!currentScannedBook) {
                console.log('No book data to save');
                return;
            }

            const saveBtn = document.getElementById('saveToISBNListBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';
            }

            const dataToSend = {
                action: 'addISBN',
                isbn: currentScannedBook.isbn,
                bookTitle: currentScannedBook.title,
                authors: currentScannedBook.authors,
                publisher: currentScannedBook.publisher,
                publishedDate: currentScannedBook.publishedDate,
                categories: currentScannedBook.categories,
                lanaguage: currentScannedBook.lanaguage
            };

            console.log('Saving to ISBN_List:', dataToSend);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                const result = await response.json();
                console.log('Save result:', result);

                if (result.success) {
                    showAlert('‚úÖ Book saved to ISBN_List successfully!', 'success');
                    // Auto-refresh the ISBN List grid view
                    await loadISBNList();
                    clearScannedBook();
                } else {
                    // Show alert only if it's not a duplicate
                    if (!result.message.includes('already exists')) {
                        showAlert('Failed: ' + result.message, 'error');
                    } else {
                        console.log('Book already in ISBN_List:', result.message);
                        // Still refresh to show it's there
                        await loadISBNList();
                    }
                }
            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Error saving book', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save to ISBN List';
                }
            }
        }

        // Load ISBN_List from Google Sheets
        async function loadISBNList() {
            const tableContainer = document.getElementById('isbnTableContainer');
            tableContainer.innerHTML = '<div class="empty-grid-message">Loading...</div>';

            const dataToSend = {
                action: 'getISBNList'
            };

            console.log('üì• Loading ISBN_List from Google Sheets...');
            console.log('API URL:', API_URL);
            console.log('Request:', JSON.stringify(dataToSend));

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                console.log('Response status:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('‚úì Response received:', result);
                console.log('Success:', result.success);
                console.log('Data length:', result.data ? result.data.length : 'null');
                console.log('Full data:', result.data);

                if (result.success) {
                    if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                        console.log('‚úì Displaying', result.data.length, 'books in table');
                        displayISBNTable(result.data);
                    } else {
                        console.log('‚ÑπÔ∏è No books in ISBN_List');
                        tableContainer.innerHTML = '<div class="empty-grid-message">No books saved yet. Scan a book to get started!</div>';
                        document.getElementById('slideToSaveSection').style.display = 'none';
                    }
                } else {
                    console.error('‚ùå Server returned success=false:', result.message);
                    tableContainer.innerHTML = `<div class="empty-grid-message">Server Error: ${result.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('‚ùå Error loading ISBN List:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                tableContainer.innerHTML = `
                    <div class="empty-grid-message">
                        Error loading ISBN List<br>
                        <small style="color: #999; margin-top: 10px; display: block;">${error.message}</small><br>
                        <button onclick="loadISBNList()" style="margin-top: 10px; padding: 8px 16px; background: #2e8b57; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        // Display ISBN_List in table view
        function displayISBNTable(books) {
            console.log('üìä displayISBNTable called with:', books);
            console.log('Books array length:', books ? books.length : 'null');

            const tableContainer = document.getElementById('isbnTableContainer');

            if (!books || books.length === 0) {
                console.log('‚ö†Ô∏è No books to display');
                tableContainer.innerHTML = '<div class="empty-grid-message">No books saved yet. Scan a book to get started!</div>';
                return;
            }

            // Sort books by most recent (reverse order)
            const sortedBooks = [...books].reverse();
            console.log('üìã Sorted books:', sortedBooks);

            let tableHTML = `
                <table class="isbn-table">
                    <thead>
                        <tr>
                            <th>ISBN</th>
                            <th>Book Title</th>
                            <th>Author</th>
                            <th>Genre</th>
                            <th>Category</th>
                            <th>Language</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedBooks.forEach((book, index) => {
                console.log(`Book ${index + 1}:`, book);

                // Split categories into genre and category (if available)
                const categories = book.categories ? book.categories.split(',').map(c => c.trim()) : [];
                const genre = categories[0] || 'N/A';
                const category = categories.slice(1).join(', ') || categories[0] || 'N/A';

                console.log(`  - Genre: ${genre}, Category: ${category}`);

                tableHTML += `
                    <tr data-isbn="${book.isbn}"
                        data-title="${book.bookTitle || 'Unknown Title'}"
                        data-author="${book.authors || 'N/A'}"
                        data-genre="${genre}"
                        data-category="${category}">
                        <td>${book.isbn || 'N/A'}</td>
                        <td><strong>${book.bookTitle || 'Unknown Title'}</strong></td>
                        <td>${book.authors || 'N/A'}</td>
                        <td>${genre}</td>
                        <td>${category}</td>
                        <td>${language}</td>
                    </tr>
                `;
            });

            console.log('‚úì Table HTML generated, rows:', sortedBooks.length);

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
            console.log('‚úì Table inserted into DOM');

            // Update book count
            document.getElementById('bookCount').textContent = sortedBooks.length;
            console.log('‚úì Book count updated:', sortedBooks.length);

            // Show the slide button section
            document.getElementById('slideToSaveSection').style.display = 'block';
            console.log('‚úì Slide button section shown');

            // Initialize the main slide button
            initializeMainSlideButton();
            console.log('‚úì Slide button initialized');

            // Activate glossy green state when books are loaded
            const slideContainer = document.getElementById('mainSlideButton');
            if (slideContainer) {
                slideContainer.classList.add('active');
                console.log('‚úì Slide button activated (glossy green)');
            }
        }

        // Initialize main slide button functionality
        function initializeMainSlideButton() {
            const container = document.getElementById('mainSlideButton');
            if (!container) return;

            const slideButton = container.querySelector('.slide-button');
            const slideBackground = container.querySelector('.slide-background');
            let isDragging = false;
            let startX = 0;
            let currentX = 0;

            const handleStart = (e) => {
                isDragging = true;
                startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                slideButton.style.transition = 'none';
                slideBackground.style.transition = 'none';
            };

            const handleMove = (e) => {
                if (!isDragging) return;

                e.preventDefault();
                currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const deltaX = currentX - startX;
                const maxDistance = container.offsetWidth - slideButton.offsetWidth - 10;

                if (deltaX >= 0 && deltaX <= maxDistance) {
                    slideButton.style.left = `${5 + deltaX}px`;
                    const percentage = (deltaX / maxDistance) * 100;
                    slideBackground.style.width = `${percentage}%`;
                }
            };

            const handleEnd = async (e) => {
                if (!isDragging) return;
                isDragging = false;

                slideButton.style.transition = 'all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';
                slideBackground.style.transition = 'width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';

                const deltaX = currentX - startX;
                const maxDistance = container.offsetWidth - slideButton.offsetWidth - 10;

                // If slid more than 80%, trigger save
                if (deltaX > maxDistance * 0.8) {
                    container.classList.add('unlocked');
                    slideButton.textContent = '‚úì';
                    slideBackground.style.width = '100%';

                    await saveToBookRegistryFromSlide(container);
                } else {
                    // Reset
                    slideButton.style.left = '5px';
                    slideBackground.style.width = '0%';
                }
            };

            // Mouse events
            slideButton.addEventListener('mousedown', handleStart);
            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);

            // Touch events
            slideButton.addEventListener('touchstart', handleStart, { passive: false });
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
        }

        // Save ALL books to Book_Registry Sheet from main slide button (BULK SAVE)
        async function saveToBookRegistryFromSlide(slideContainer) {
            // Validate form fields
            const contactPerson = document.getElementById('contactPerson').value.trim();
            const contactNumber = document.getElementById('contactNumber').value.trim();
            const unitNo = document.getElementById('unitNo').value.trim();

            if (!contactPerson || !contactNumber || !unitNo) {
                showAlert('‚ö†Ô∏è Please fill in Contact Person, Contact Number, and Unit No before saving!', 'error');

                // Reset slide button
                setTimeout(() => {
                    resetSlideButton(slideContainer);
                }, 500);

                return;
            }

            // Get all books from the table
            const rows = document.querySelectorAll('.isbn-table tbody tr');

            if (rows.length === 0) {
                showAlert('‚ö†Ô∏è No books to save!', 'error');
                setTimeout(() => {
                    resetSlideButton(slideContainer);
                }, 500);
                return;
            }

            // Switch to processing state
            slideContainer.classList.remove('active', 'unlocked');
            slideContainer.classList.add('processing');
            const slideText = slideContainer.querySelector('.slide-text');
            const slideButton = slideContainer.querySelector('.slide-button');
            slideText.textContent = '‚è≥ Processing...';
            slideButton.textContent = '‚è≥';

            console.log('üîÑ Switched to processing state');

            const books = [];
            rows.forEach(row => {
                books.push({
                    isbn: row.dataset.isbn,
                    bookTitle: row.dataset.title,
                    author: row.dataset.author,
                    genre: row.dataset.genre,
                    category: row.dataset.category
                });
            });

            const dataToSend = {
                action: 'bulkSaveToBookRegistry',
                books: books,
                contactPerson: contactPerson,
                contactNumber: contactNumber,
                unitNo: unitNo,
                language: '' // Empty for now
            };

            console.log('Bulk saving to Book_Registry:', dataToSend);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                const result = await response.json();
                console.log('Bulk save result:', result);

                if (result.success) {
                    // Switch to success state
                    slideContainer.classList.remove('processing', 'active');
                    slideContainer.classList.add('unlocked');
                    slideText.textContent = '‚úÖ Saved Successfully!';
                    slideButton.textContent = '‚úì';

                    console.log('‚úÖ Switched to success state');

                    showAlert(`‚úÖ Successfully saved ${result.data.savedCount || books.length} book(s) to Book Registry!`, 'success');

                    // Clear the entire table with animation after brief delay
                    setTimeout(() => {
                        const tbody = document.querySelector('.isbn-table tbody');
                        if (tbody) {
                            // Animate all rows out
                            rows.forEach((row, index) => {
                                setTimeout(() => {
                                    row.style.opacity = '0';
                                    row.style.transform = 'translateX(100%)';
                                }, index * 50); // Stagger the animations
                            });

                            // After all animations, clear the view
                            setTimeout(() => {
                                // Reset slider to initial glossy grey state before hiding
                                resetSlideButton(slideContainer);

                                document.getElementById('slideToSaveSection').style.display = 'none';
                                loadISBNList(); // Reload to show empty message

                                // Clear the form fields
                                document.getElementById('contactPerson').value = '';
                                document.getElementById('contactNumber').value = '';
                                document.getElementById('unitNo').value = '';
                            }, rows.length * 50 + 300);
                        }
                    }, 1000); // Wait 1 second to show success state
                } else {
                    showAlert('Failed: ' + result.message, 'error');

                    // Reset slide button back to active state
                    setTimeout(() => {
                        resetSlideButton(slideContainer);
                    }, 500);
                }
            } catch (error) {
                console.error('Error bulk saving to Book Registry:', error);
                showAlert('Error saving books to registry', 'error');

                // Reset slide button back to active state
                setTimeout(() => {
                    resetSlideButton(slideContainer);
                }, 500);
            }
        }

        // Reset slide button helper function
        function resetSlideButton(slideContainer) {
            slideContainer.classList.remove('unlocked', 'processing', 'active');
            const slideButton = slideContainer.querySelector('.slide-button');
            const slideBackground = slideContainer.querySelector('.slide-background');
            const slideText = slideContainer.querySelector('.slide-text');
            slideButton.textContent = '‚Üí';
            slideText.textContent = 'Slide to Save All ‚Üí';
            slideButton.style.left = '5px';
            slideBackground.style.width = '0%';
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            checkIframePermissions();
            // Load ISBN_List on page load
            loadISBNList();
        });
    </script>
</body>
</html>
