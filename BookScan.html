<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Camera permissions -->
    <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=(self)">
    <meta http-equiv="Feature-Policy" content="camera 'self'; microphone 'self'">

    <title>Book Barcode Scanner</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #2e8b57;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .info-box {
            background-color: #e7f3ff;
            padding: 18px;
            border-left: 5px solid #2196F3;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .warning-box {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(238, 90, 111, 0.3);
            border: 3px solid #ff5252;
            display: none;
        }

        .warning-box h2 {
            color: white;
            margin-top: 0;
            font-size: 24px;
            text-align: center;
        }

        .warning-box p {
            color: white;
            margin: 15px 0;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2e8b57 0%, #3cb371 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 139, 87, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: white;
            color: #ff5252;
            padding: 20px 50px;
            font-size: 20px;
        }

        .btn-warning:hover {
            transform: scale(1.05);
        }

        #cameraViewContainer {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        #reader {
            width: 100%;
            border: 2px solid #2e8b57;
            border-radius: 10px;
        }

        #scanStatus {
            margin-top: 10px;
            background: #e7f3ff;
            color: #2196F3;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
            border-left: 4px solid #2196F3;
        }

        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        #scannedBookDetails {
            display: none;
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #2e8b57;
            margin-bottom: 20px;
        }

        #scannedBookDetails h3 {
            color: #2e8b57;
            margin-bottom: 20px;
        }

        .detail-item {
            margin-bottom: 15px;
        }

        .detail-item strong {
            color: #5d4e37;
            display: block;
            margin-bottom: 5px;
        }

        .detail-item p {
            margin: 0;
            font-size: 16px;
        }

        #historyList {
            display: grid;
            gap: 10px;
        }

        .history-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e8b57;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            max-width: 400px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        /* ISBN List Grid View */
        #isbnListSection {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #2e8b57;
        }

        #isbnListSection h3 {
            color: #2e8b57;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-grid-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .refresh-grid-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
        }

        .isbn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .isbn-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2e8b57;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .isbn-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .isbn-card-title {
            font-weight: 600;
            font-size: 16px;
            color: #2e8b57;
            margin-bottom: 8px;
        }

        .isbn-card-info {
            font-size: 13px;
            color: #666;
            margin: 4px 0;
        }

        .isbn-card-isbn {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            font-family: monospace;
        }

        .empty-grid-message {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 12px 30px;
                font-size: 14px;
            }

            .isbn-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì∑ Book Barcode Scanner</h1>
        <p class="subtitle">Scan ISBN barcodes to automatically retrieve book information</p>

        <!-- Info Box -->
        <div class="info-box">
            <strong>üìñ How to use:</strong> Click "Start Scanner" below to activate your camera. Point it at a book's ISBN barcode. Once scanned, book details will be fetched automatically from Google Books.
        </div>

        <!-- Iframe Warning -->
        <div id="iframeWarning" class="warning-box">
            <h2>‚ö†Ô∏è Camera Access Blocked</h2>
            <p>
                This page is embedded and camera access is blocked.<br>
                <strong>Click the button below to use the scanner:</strong>
            </p>
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="openInNewTab()" class="btn btn-warning">
                    üì∑ Open Scanner (Click Here!)
                </button>
            </div>
            <p style="font-size: 14px; opacity: 0.9;">
                This will open the scanner in a new tab where your camera will work.
            </p>
        </div>

        <!-- Camera View -->
        <div id="cameraViewContainer">
            <div id="reader"></div>
            <div id="scanStatus">Ready to scan</div>
        </div>

        <!-- Scanner Controls -->
        <div class="controls">
            <button id="startScanBtn" class="btn btn-primary" onclick="startScanner()">
                üì∑ Start Scanner
            </button>
            <button id="stopScanBtn" class="btn btn-secondary" onclick="stopScanner()" style="display: none;">
                ‚èπÔ∏è Stop Scanner
            </button>
        </div>

        <!-- Scanned Book Details -->
        <div id="scannedBookDetails">
            <h3>üìö Scanned Book Details</h3>
            <div class="detail-item">
                <strong>ISBN:</strong>
                <p id="scannedISBN"></p>
            </div>
            <div class="detail-item">
                <strong>Book Title:</strong>
                <p id="scannedBookTitle" style="font-weight: 600;"></p>
            </div>
            <div class="detail-item">
                <strong>Author(s):</strong>
                <p id="scannedAuthor"></p>
            </div>
            <div class="detail-item">
                <strong>Publisher:</strong>
                <p id="scannedPublisher"></p>
            </div>
            <div class="detail-item">
                <strong>Published Date:</strong>
                <p id="scannedPublishedDate"></p>
            </div>
            <div class="detail-item">
                <strong>Categories:</strong>
                <p id="scannedCategories"></p>
            </div>
            <div class="detail-item">
                <strong>Description:</strong>
                <p id="scannedDescription" style="font-size: 14px; line-height: 1.6; color: #666;"></p>
            </div>

            <div style="margin-top: 25px; text-align: center;">
                <button id="saveToISBNListBtn" class="btn btn-primary" onclick="saveToISBNList()" style="display: none;">
                    üíæ Save to ISBN List
                </button>
                <button class="btn btn-secondary" onclick="clearScannedBook()">
                    üîÑ Scan Another
                </button>
            </div>
        </div>

        <!-- Scanned Books History -->
        <div id="scannedBooksHistory" style="margin-top: 30px;">
            <h3 style="color: #2e8b57; margin-bottom: 15px;">üìã Recently Scanned Books</h3>
            <div id="historyList">
                <p style="text-align: center; color: #666; font-style: italic;">No books scanned yet</p>
            </div>
        </div>

        <!-- ISBN List Grid View -->
        <div id="isbnListSection">
            <h3>
                <span>üìö ISBN List - Saved Books</span>
                <button class="refresh-grid-btn" onclick="loadISBNList()">üîÑ Refresh</button>
            </h3>
            <div id="isbnGrid" class="isbn-grid">
                <div class="empty-grid-message">Loading ISBN List...</div>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alertBox" class="alert"></div>

    <script>
        // Configuration
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbytd5eKdlkBLJ9nxS2jx1C5A4pFNdkISnJoPwt2VFu7jzUpMYOa_F6oeZh1o4GY-pOO_w/exec';
        let API_URL = localStorage.getItem('apiUrl') || DEFAULT_API_URL;

        let html5QrcodeScanner = null;
        let currentScannedBook = null;
        let scannedBooksHistory = [];
        let isScannerActive = false;

        // Check if running in iframe
        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }

        // Open in new tab
        function openInNewTab() {
            const currentUrl = window.location.href;
            window.open(currentUrl, '_blank');
        }

        // Show alert
        function showAlert(message, type) {
            const alertEl = document.getElementById('alertBox');
            alertEl.textContent = message;
            alertEl.className = 'alert alert-' + type;
            alertEl.style.display = 'block';

            setTimeout(() => {
                alertEl.style.display = 'none';
            }, 5000);
        }

        // Check iframe permissions on load
        async function checkIframePermissions() {
            console.log('=== IFRAME PERMISSION CHECK ===');

            if (!isInIframe()) {
                console.log('‚úÖ Not in iframe - camera should work normally');
                document.getElementById('iframeWarning').style.display = 'none';
                return;
            }

            console.log('‚ö†Ô∏è Running in iframe - checking camera...');
            document.getElementById('iframeWarning').style.display = 'block';

            try {
                const testStream = await navigator.mediaDevices.getUserMedia({ video: true });
                testStream.getTracks().forEach(track => track.stop());
                console.log('‚úÖ Camera IS accessible in iframe!');
                document.getElementById('iframeWarning').style.display = 'none';
            } catch (error) {
                console.log('‚ùå Camera NOT accessible in iframe');
                document.getElementById('iframeWarning').style.display = 'block';
            }
        }

        // Check camera permissions
        async function checkCameraPermissions() {
            console.log('=== CAMERA PERMISSION CHECK ===');

            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                throw new Error('Camera access requires HTTPS.');
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Your browser does not support camera access.');
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    throw new Error('Camera permission denied. Please click "Allow" when asked.');
                }
                throw error;
            }
        }

        // Start Scanner
        async function startScanner() {
            try {
                document.getElementById('cameraViewContainer').style.display = 'block';
                document.getElementById('scanStatus').textContent = 'Checking camera permissions...';

                await checkCameraPermissions();
                document.getElementById('iframeWarning').style.display = 'none';

                document.getElementById('scanStatus').textContent = 'Initializing camera...';

                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5Qrcode("reader");
                }

                const config = {
                    fps: 10,
                    qrbox: { width: 300, height: 150 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E
                    ]
                };

                const onScanSuccess = async (decodedText) => {
                    console.log('Scanned barcode:', decodedText);
                    document.getElementById('scanStatus').textContent = `ISBN detected: ${decodedText}. Fetching book details...`;
                    document.getElementById('scanStatus').style.background = '#d4edda';
                    document.getElementById('scanStatus').style.color = '#155724';
                    document.getElementById('scanStatus').style.borderLeft = '4px solid #28a745';

                    await stopScanner();
                    await fetchBookDetails(decodedText);
                };

                const onScanFailure = (error) => {
                    // Ignore - fires when no barcode detected
                };

                try {
                    await html5QrcodeScanner.start(
                        { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                } catch (error) {
                    await html5QrcodeScanner.start(
                        { facingMode: "user" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    );
                }

                isScannerActive = true;
                document.getElementById('scanStatus').textContent = 'Point camera at ISBN barcode...';
                document.getElementById('scanStatus').style.background = '#e7f3ff';
                document.getElementById('scanStatus').style.color = '#2196F3';
                document.getElementById('scanStatus').style.borderLeft = '4px solid #2196F3';
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-block';

                showAlert('Scanner activated!', 'success');
            } catch (error) {
                console.error('‚ùå Error starting scanner:', error);

                if (isInIframe() && (error.name === 'NotAllowedError' || error.message.includes('denied'))) {
                    document.getElementById('iframeWarning').style.display = 'block';
                }

                showAlert(error.message || 'Failed to start camera', 'error');
                document.getElementById('cameraViewContainer').style.display = 'none';
                isScannerActive = false;
            }
        }

        // Stop Scanner
        async function stopScanner() {
            try {
                if (html5QrcodeScanner && isScannerActive) {
                    await html5QrcodeScanner.stop();
                    isScannerActive = false;
                }

                document.getElementById('cameraViewContainer').style.display = 'none';
                document.getElementById('startScanBtn').style.display = 'inline-block';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('scanStatus').textContent = 'Ready to scan';
                document.getElementById('scanStatus').style.background = '#e7f3ff';
                document.getElementById('scanStatus').style.color = '#2196F3';
            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
        }

        // Fetch Book Details from Google Books API
        async function fetchBookDetails(isbn) {
            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const bookInfo = data.items[0].volumeInfo;

                    currentScannedBook = {
                        isbn: isbn,
                        title: bookInfo.title || 'N/A',
                        authors: bookInfo.authors ? bookInfo.authors.join(', ') : 'N/A',
                        publisher: bookInfo.publisher || 'N/A',
                        publishedDate: bookInfo.publishedDate || 'N/A',
                        categories: bookInfo.categories ? bookInfo.categories.join(', ') : 'N/A',
                        description: bookInfo.description || 'No description available'
                    };

                    displayScannedBook(currentScannedBook);
                    addToHistory(currentScannedBook);
                    showAlert('Book details retrieved!', 'success');

                    // Auto-save to ISBN_List
                    await saveToISBNList();
                } else {
                    showAlert('No book details found for ISBN: ' + isbn, 'error');
                    currentScannedBook = {
                        isbn: isbn,
                        title: 'Not Found',
                        authors: 'N/A',
                        publisher: 'N/A',
                        publishedDate: 'N/A',
                        categories: 'N/A',
                        description: 'No information available for this ISBN'
                    };
                    displayScannedBook(currentScannedBook);
                }
            } catch (error) {
                console.error('Error fetching book details:', error);
                showAlert('Error fetching book details', 'error');
            }
        }

        // Display Scanned Book
        function displayScannedBook(book) {
            document.getElementById('scannedISBN').textContent = book.isbn;
            document.getElementById('scannedBookTitle').textContent = book.title;
            document.getElementById('scannedAuthor').textContent = book.authors;
            document.getElementById('scannedPublisher').textContent = book.publisher;
            document.getElementById('scannedPublishedDate').textContent = book.publishedDate;
            document.getElementById('scannedCategories').textContent = book.categories;
            document.getElementById('scannedDescription').textContent = book.description;
            document.getElementById('scannedBookDetails').style.display = 'block';
        }

        // Clear Scanned Book
        function clearScannedBook() {
            currentScannedBook = null;
            document.getElementById('scannedBookDetails').style.display = 'none';
        }

        // Add to History
        function addToHistory(book) {
            scannedBooksHistory.unshift(book);
            if (scannedBooksHistory.length > 10) {
                scannedBooksHistory.pop();
            }
            updateHistoryDisplay();
        }

        // Update History Display
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');

            if (scannedBooksHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No books scanned yet</p>';
                return;
            }

            historyList.innerHTML = scannedBooksHistory.map(book => `
                <div class="history-item">
                    <strong style="color: #2e8b57; font-size: 14px;">${book.title}</strong>
                    <p style="margin: 5px 0; color: #666; font-size: 13px;">by ${book.authors}</p>
                    <p style="margin: 5px 0; color: #999; font-size: 12px;">ISBN: ${book.isbn}</p>
                </div>
            `).join('');
        }

        // Save to ISBN_List Sheet
        async function saveToISBNList() {
            if (!currentScannedBook) {
                console.log('No book data to save');
                return;
            }

            const saveBtn = document.getElementById('saveToISBNListBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'üíæ Saving...';
            }

            const dataToSend = {
                action: 'addISBN',
                isbn: currentScannedBook.isbn,
                bookTitle: currentScannedBook.title,
                authors: currentScannedBook.authors,
                publisher: currentScannedBook.publisher,
                publishedDate: currentScannedBook.publishedDate,
                categories: currentScannedBook.categories
            };

            console.log('Saving to ISBN_List:', dataToSend);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                const result = await response.json();
                console.log('Save result:', result);

                if (result.success) {
                    showAlert('‚úÖ Book saved to ISBN_List successfully!', 'success');
                    // Auto-refresh the ISBN List grid view
                    await loadISBNList();
                    clearScannedBook();
                } else {
                    // Show alert only if it's not a duplicate
                    if (!result.message.includes('already exists')) {
                        showAlert('Failed: ' + result.message, 'error');
                    } else {
                        console.log('Book already in ISBN_List:', result.message);
                        // Still refresh to show it's there
                        await loadISBNList();
                    }
                }
            } catch (error) {
                console.error('Error saving:', error);
                showAlert('Error saving book', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Save to ISBN List';
                }
            }
        }

        // Load ISBN_List from Google Sheets
        async function loadISBNList() {
            const gridContainer = document.getElementById('isbnGrid');
            gridContainer.innerHTML = '<div class="empty-grid-message">Loading...</div>';

            const dataToSend = {
                action: 'getISBNList'
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend),
                    redirect: 'follow'
                });

                const result = await response.json();
                console.log('ISBN List result:', result);

                if (result.success && result.data && result.data.length > 0) {
                    displayISBNGrid(result.data);
                } else {
                    gridContainer.innerHTML = '<div class="empty-grid-message">No books saved yet. Scan a book to get started!</div>';
                }
            } catch (error) {
                console.error('Error loading ISBN List:', error);
                gridContainer.innerHTML = '<div class="empty-grid-message">Error loading ISBN List. Please try again.</div>';
            }
        }

        // Display ISBN_List in grid view
        function displayISBNGrid(books) {
            const gridContainer = document.getElementById('isbnGrid');

            if (!books || books.length === 0) {
                gridContainer.innerHTML = '<div class="empty-grid-message">No books saved yet. Scan a book to get started!</div>';
                return;
            }

            // Sort books by most recent (reverse order)
            const sortedBooks = [...books].reverse();

            gridContainer.innerHTML = sortedBooks.map(book => `
                <div class="isbn-card">
                    <div class="isbn-card-title">${book.bookTitle || 'Unknown Title'}</div>
                    <div class="isbn-card-info">
                        <strong>Author:</strong> ${book.authors || 'N/A'}
                    </div>
                    <div class="isbn-card-info">
                        <strong>Publisher:</strong> ${book.publisher || 'N/A'}
                    </div>
                    <div class="isbn-card-info">
                        <strong>Published:</strong> ${book.publishedDate || 'N/A'}
                    </div>
                    ${book.categories ? `<div class="isbn-card-info">
                        <strong>Categories:</strong> ${book.categories}
                    </div>` : ''}
                    <div class="isbn-card-isbn">üìñ ISBN: ${book.isbn || 'N/A'}</div>
                </div>
            `).join('');
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            checkIframePermissions();
            // Load ISBN_List on page load
            loadISBNList();
        });
    </script>
</body>
</html>
